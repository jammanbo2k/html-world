<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AIPI × ECI Glass Dashboard — autoschema/autofill (FIX)</title>
<!-- libs -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
<style>
  :root{
    --bg: radial-gradient(1200px 800px at 10% 10%, #0d1222 0%, #0a0f1a 60%, #070b13 100%);
    --glass: rgba(255,255,255,0.10);
    --border: 1px solid rgba(255,255,255,0.22);
    --blur: 14px;
    --text: #edf2ff; --muted:#c7d0df; --accent:#86a8ff;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,'Noto Sans KR','Apple SD Gothic Neo',Arial}
  .wrap{max-width:1220px;margin:28px auto 80px;padding:0 16px}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(134,168,255,.18);border:1px solid rgba(134,168,255,.38);font-size:12px}
  h1{font-size:clamp(20px,3.8vw,28px);margin:0}
  .grid{display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:1024px){.grid{grid-template-columns:1.25fr .9fr}}
  .card{background:var(--glass);border-radius:20px;border:var(--border);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));box-shadow:0 12px 36px rgba(0,0,0,.28);padding:14px 14px 10px}
  .card h3{margin:2px 6px 10px;font-size:16px;color:var(--muted)}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 6px 12px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
  input[type="file"],select,button{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.25);color:var(--text);padding:8px 10px;border-radius:10px;font-size:13px}
  button:hover{background:rgba(255,255,255,.12);cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;margin:4px 6px 6px}
  .kpi{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:8px 10px}
  .kpi b{font-size:14px}
  .hint{font-size:12px;color:var(--muted);margin:4px 6px}
  a{color:var(--accent);text-decoration:none}
  .two{display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:900px){.two{grid-template-columns:1fr 1fr}}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.12)}
  th{color:#e3ebff;text-align:left}
  td{color:#eaf1ff}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <span class="badge">Glassmorphism</span>
    <h1>AIPI × ECI 글래스 대시보드 — autoschema/autofill (FIX)</h1>
  </div>

  <div class="card">
    <h3>0) 데이터 업로드 (사내망·오프라인 지원)</h3>
    <div class="controls row">
      <label class="pill">AIPI CSV (필수)
        <input type="file" id="aipiFile" accept=".csv" />
      </label>
      <label class="pill">ECI CSV (필수)
        <input type="file" id="eciFile" accept=".csv" />
      </label>
      <button id="load">불러오기</button>
      <span class="pill">스키마 자동 인식 <code>(Country,AIPI)</code>, <code>(country,aipi)</code>, 또는 롱/와이드 포맷</span>
    </div>
    <div class="hint">권장 AIPI 스키마(간단): <code>Country,AIPI</code> (대/소문자 허용).<br/>ECI 스키마 예: <code>Country,ECI,Rank</code> 또는 <code>iso3,label,eci,rank</code>.</div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>1) 산점도: AIPI vs ECI (국가별)</h3>
      <div class="controls">
        <label class="pill">필터
          <select id="filter">
            <option value="ALL">전체</option>
            <option value="OECD">OECD만</option>
          </select>
        </label>
        <button id="exportCSV">잔차표 내보내기</button>
      </div>
      <div id="scatter" style="width:100%;height:520px;"></div>
      <div class="kpis" id="kpis"></div>
      <div class="hint">회귀선 = ECI로 예측한 AIPI 기준선. 점이 선 위면 <b>초과 성과</b>, 아래면 <b>개선 여지</b>.</div>
    </div>

    <div class="card">
      <h3>2) 잔차(초과/미달 성과) 순위</h3>
      <div id="residuals" style="width:100%;height:520px;"></div>
    </div>
  </div>

  <div class="two">
    <div class="card">
      <h3>3) 표: 상위 15개 초과 성과국</h3>
      <div id="tableUp"></div>
    </div>
    <div class="card">
      <h3>4) 표: 하위 15개 미달 성과국</h3>
      <div id="tableDown"></div>
    </div>
  </div>

  <div class="card">
    <h3>도움말</h3>
    <div class="hint">• <b>Autoschema</b>: 컬럼명이 달라도 자동 매핑합니다. (예: <code>Country</code>/<code>country</code>/<code>label</code>, <code>AIPI</code>/<code>aipi</code>/<code>value</code>)<br/>
    • <b>Autofill</b>: AIPI가 연도별 열(와이드)이어도 최신 연도를 자동 선택합니다.<br/>
    • <b>OECD 필터</b>: 내장 목록으로 간단 비교. 별도 목록이 있으면 쉽게 교체 가능합니다.</div>
  </div>
</div>

<script>
const OECD = new Set(["AUS","AUT","BEL","CAN","CHE","CHL","COL","CZE","DEU","DNK","ESP","EST","FIN","FRA","GBR","GRC","HUN","IRL","ISL","ISR","ITA","JPN","KOR","LTU","LUX","LVA","MEX","NLD","NOR","NZL","POL","PRT","SVK","SVN","SWE","TUR","USA"]); // 38개(2025 기준 구성 유지)
const dom = id => document.getElementById(id);

let rows = []; // unified rows: {country, iso3?, aipi, eci}
let residuals = []; // {country, aipi, eci, pred, resid}

function normHead(h){ return (h||"").replace(/^ï»¿/,"").trim().toLowerCase().replace(/\s+/g,""); }

function parseCSV(file){
  return new Promise((resolve,reject)=>{
    Papa.parse(file, {header:true, skipEmptyLines:true, transformHeader:normHead,
      complete: (res)=> resolve(res.data), error: (e)=> reject(e)
    });
  });
}

// ---- AIPI autoschema/autofill ----
function coerceAIPI(raw){
  if(!raw || !raw.length) return [];
  const keys = Object.keys(raw[0]).map(normHead);
  const findKey = (cands) => keys.find(k => cands.includes(k));
  const countryKey = findKey(["country","label","name"]);
  const isoKey = findKey(["iso3","code","countrycode","country_code","iso"]);
  // detect wide (year columns)
  const yearCols = keys.filter(k=>/^\d{4}$/.test(k));
  let out = [];
  if(yearCols.length){ // wide → take latest non-empty per row
    const latest = yearCols.sort().slice(-1)[0];
    for(const r of raw){
      const v = Number(r[latest]);
      if(Number.isFinite(v)){
        out.push({ country: (r[countryKey]||r[isoKey]||"").toString().trim(), iso3: (r[isoKey]||"").toString().toUpperCase(), aipi: v });
      }
    }
    return out;
  }
  // long / simple
  const aKey = findKey(["aipi","ai_pi","value"]);
  if(!aKey){ return []; }
  for(const r of raw){
    const v = Number(r[aKey]);
    if(!Number.isFinite(v)) continue;
    out.push({ country: (r[countryKey]||r[isoKey]||"").toString().trim(), iso3: (r[isoKey]||"").toString().toUpperCase(), aipi: v });
  }
  return out;
}

// ---- ECI autoschema ----
function coerceECI(raw){
  if(!raw || !raw.length) return [];
  const keys = Object.keys(raw[0]).map(normHead);
  const findKey = (cands) => keys.find(k => cands.includes(k));
  const countryKey = findKey(["country","label","name"]);
  const isoKey = findKey(["iso3","code","countrycode","country_code","iso"]);
  const eciKey = findKey(["eci","economiccomplexityindex","value","score"]);
  if(!eciKey) return [];
  let out = [];
  for(const r of raw){
    const val = Number(r[eciKey]);
    if(!Number.isFinite(val)) continue;
    out.push({ country: (r[countryKey]||r[isoKey]||"").toString().trim(), iso3: (r[isoKey]||"").toString().toUpperCase(), eci: val });
  }
  return out;
}

// unify by country (iso3 preferred)
function mergeByCountry(aipiArr, eciArr){
  const map = new Map();
  for(const r of aipiArr){
    const key = (r.iso3 && r.iso3.length===3)? r.iso3 : r.country.toLowerCase();
    map.set(key, { country: r.country, iso3:r.iso3, aipi:r.aipi, eci: undefined });
  }
  for(const r of eciArr){
    const key = (r.iso3 && r.iso3.length===3)? r.iso3 : r.country.toLowerCase();
    const cur = map.get(key) || { country:r.country, iso3:r.iso3 };
    cur.eci = r.eci;
    if(!cur.country && r.country) cur.country = r.country;
    if(!cur.iso3 && r.iso3) cur.iso3 = r.iso3;
    map.set(key, cur);
  }
  return Array.from(map.values()).filter(o => Number.isFinite(o.aipi) && Number.isFinite(o.eci));
}

// simple linear regression y = a + b x
function linreg(pairs){
  const n = pairs.length; if(!n) return null;
  let sx=0, sy=0, sxx=0, sxy=0, syy=0;
  for(const [x,y] of pairs){ sx+=x; sy+=y; sxx+=x*x; sxy+=x*y; syy+=y*y; }
  const b = (n*sxy - sx*sy) / (n*sxx - sx*sx);
  const a = (sy - b*sx)/n;
  // R^2
  const ybar = sy/n;
  let ssTot=0, ssRes=0;
  for(const [x,y] of pairs){
    const yhat = a + b*x;
    ssTot += (y - ybar)**2;
    ssRes += (y - yhat)**2;
  }
  const r2 = ssTot ? (1 - ssRes/ssTot) : 0;
  return {a,b,r2, yhat:(x)=>a+b*x};
}

function makeScatter(data, filter){
  const filtered = data.filter(r => filter==="OECD" ? OECD.has((r.iso3||"").toUpperCase()) : true);
  if(!filtered.length){
    Plotly.newPlot("scatter", [], {paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)"});
    dom("kpis").innerHTML = "<div class='kpi'>표시할 데이터 없음</div>";
    return;
  }
  const pairs = filtered.map(r => [r.eci, r.aipi]);
  const lr = linreg(pairs);
  residuals = filtered.map(r => {
    const pred = lr.yhat(r.eci);
    return { country: r.country, iso3: r.iso3, aipi: r.aipi, eci: r.eci, pred, resid: r.aipi - pred };
  }).sort((a,b)=>b.resid - a.resid);

  const scatter = [{
    x: filtered.map(r=>r.eci), y: filtered.map(r=>r.aipi),
    mode:"markers", type:"scatter", text: filtered.map(r=>`${r.country}<br>ECI: ${r.eci.toFixed(2)}<br>AIPI: ${r.aipi.toFixed(2)}`)
  }];
  // regression line
  const xs = filtered.map(r=>r.eci).sort((a,b)=>a-b);
  const minx = xs[0], maxx = xs[xs.length-1];
  const lineX = [minx, maxx];
  const lineY = [lr.yhat(minx), lr.yhat(maxx)];
  scatter.push({x: lineX, y: lineY, mode:"lines", name:"회귀선"});
  const layout = {
    margin:{l:50,r:10,t:20,b:50},
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    xaxis:{title:"ECI(경제 복잡성)", tickfont:{color:"#c7d0df"}},
    yaxis:{title:"AIPI(AI 준비도)", tickfont:{color:"#c7d0df"}, gridcolor:"rgba(255,255,255,.08)"}
  };
  Plotly.newPlot("scatter", scatter, layout, {displayModeBar:false, responsive:true});

  // KPIs
  const r = Math.sqrt(lr.r2);
  dom("kpis").innerHTML =
    `<div class="kpi">표본 <b>${filtered.length}</b></div>`+
    `<div class="kpi">R <b>${r.toFixed(2)}</b></div>`+
    `<div class="kpi">R² <b>${lr.r2.toFixed(2)}</b></div>`+
    `<div class="kpi">기울기 b <b>${lr.b.toFixed(2)}</b></div>`;

  // residual chart (top +/- 15)
  const top = residuals.slice(0,15);
  const bottom = residuals.slice(-15).reverse();
  const barUp = {type:"bar", x: top.map(d=>d.country), y: top.map(d=>d.resid), name:"초과", text: top.map(d=>d.resid.toFixed(2)), textposition:"auto"};
  const barDn = {type:"bar", x: bottom.map(d=>d.country), y: bottom.map(d=>d.resid), name:"미달", text: bottom.map(d=>d.resid.toFixed(2)), textposition:"auto"};
  const layoutBar = {barmode:"group", margin:{l:50,r:10,t:20,b:60}, paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)", yaxis:{gridcolor:"rgba(255,255,255,.08)"}};
  Plotly.newPlot("residuals", [barUp, barDn], layoutBar, {displayModeBar:false, responsive:true});

  // tables
  renderTable("tableUp", top);
  renderTable("tableDown", bottom);
}

function renderTable(divId, arr){
  const header = ["순위","국가","ECI","AIPI","예측 AIPI","잔차"];
  const rows = arr.map((d,i)=>[i+1, d.country, d.eci.toFixed(2), d.aipi.toFixed(2), d.pred.toFixed(2), d.resid.toFixed(2)]);
  const div = dom(divId); div.innerHTML="";
  const tbl = document.createElement("table");
  const thead = document.createElement("thead"); const trh = document.createElement("tr");
  for(const h of header){ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); }
  thead.appendChild(trh); tbl.appendChild(thead);
  const tbody = document.createElement("tbody");
  for(const r of rows){
    const tr=document.createElement("tr");
    for(const c of r){ const td=document.createElement("td"); td.textContent=c; tr.appendChild(td); }
    tbody.appendChild(tr);
  }
  tbl.appendChild(tbody);
  div.appendChild(tbl);
}

function downloadCSV(name, rows){
  const head = "country,iso3,eci,aipi,pred,resid\n";
  const body = rows.map(r=>[r.country, r.iso3||"", r.eci, r.aipi, r.pred, r.resid].join(",")).join("\n");
  const blob = new Blob([head+body], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

async function onLoad(){
  const aipiFile = dom("aipiFile").files[0];
  const eciFile  = dom("eciFile").files[0];
  if(!aipiFile || !eciFile){
    alert("AIPI와 ECI CSV를 모두 선택해 주세요.");
    return;
  }
  try{
    const [aipiRaw, eciRaw] = await Promise.all([parseCSV(aipiFile), parseCSV(eciFile)]);
    const A = coerceAIPI(aipiRaw);
    const E = coerceECI(eciRaw);
    if(!A.length) throw new Error("AIPI 파일 스키마를 인식하지 못했습니다. (예: Country,AIPI) 형식 권장");
    if(!E.length) throw new Error("ECI 파일 스키마를 인식하지 못했습니다. (예: Country,ECI[,Rank])");
    rows = mergeByCountry(A, E);
    if(!rows.length) throw new Error("AIPI와 ECI를 매칭할 수 없습니다. (국가명/ISO3를 확인)");
    makeScatter(rows, dom("filter").value);
  }catch(err){
    console.error(err);
    alert("불러오기 오류: " + err.message);
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  const wait=()=>{
    if(window.Plotly && window.Papa){
      dom("load").onclick = onLoad;
      dom("filter").onchange = () => { if(rows.length) makeScatter(rows, dom("filter").value); };
      dom("exportCSV").onclick = () => { if(residuals.length) downloadCSV("aipi_eci_residuals.csv", residuals); };
    }else setTimeout(wait,50);
  };
  wait();
});
</script>
</body>
</html>
